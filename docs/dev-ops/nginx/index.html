<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring AI æ™ºèƒ½åŠ©æ‰‹</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --bg-color: #f4f6f8; --chat-bg: #ffffff; --user-msg-bg: #007bff; --user-msg-text: #ffffff; --bot-msg-bg: #e9ecef; --bot-msg-text: #333333; --input-area-height: 80px; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 0; background-color: var(--bg-color); display: flex; flex-direction: column; height: 100vh; }

        /* è®¾ç½®é¢æ¿ */
        #rag-settings {
            background: #fff;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            z-index: 10;
        }

        /* å¼€å…³æ ·å¼ */
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #007bff; }
        input:checked + .slider:before { transform: translateX(20px); }

        /* çŸ¥è¯†åº“æ§ä»¶åŒº */
        #kb-control-area { display: flex; align-items: center; gap: 8px; transition: all 0.3s; opacity: 1; }
        #kb-control-area.disabled { opacity: 0.4; pointer-events: none; filter: grayscale(100%); }

        .setting-group { display: flex; align-items: center; gap: 8px; }
        .setting-label { font-weight: bold; font-size: 14px; color: #555; }

        /* ä¸‹æ‹‰ä¸è¾“å…¥ */
        select, input[type="text"] { padding: 6px; border: 1px solid #ccc; border-radius: 4px; background: white; font-size: 13px; }
        #rag-tag-select { min-width: 120px; height: 32px; }
        /* æ¨¡å‹é€‰æ‹©æ ·å¼ */
        #provider-select { min-width: 100px; height: 32px; font-weight: bold; color: #333; }

        #rag-tag-input { width: 140px; height: 18px; display: none; }

        .icon-btn { background: #f0f0f0; border: 1px solid #ddd; cursor: pointer; width: 32px; height: 32px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all 0.2s; }
        .icon-btn:hover { background-color: #e0e0e0; }
        .icon-btn.active-mode { background-color: #007bff; color: white; border-color: #0056b3; }

        /* --- æ–‡ä»¶ä¸Šä¼ ä¸æ‹–æ‹½æ ·å¼ --- */
        #file-input { display: none; }
        #drop-zone { display: flex; align-items: center; gap: 8px; padding: 4px 10px; border: 2px dashed transparent; border-radius: 6px; transition: all 0.2s; margin-left: 10px; }
        #drop-zone.drag-over { border-color: #007bff; background-color: rgba(0, 123, 255, 0.1); }

        #git-zone { display: none; align-items: center; gap: 8px; margin-left: 10px; }
        #git-url-input { width: 240px; height: 18px; }

        .btn-upload-trigger { background-color: #6c757d; color: white; padding: 0 12px; height: 32px; line-height: 32px; border-radius: 4px; cursor: pointer; font-size: 13px; display: inline-block; }
        .btn-do-upload { background-color: #28a745; color: white; border: none; padding: 0 15px; height: 32px; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .btn-do-upload:disabled { background-color: #ccc; cursor: not-allowed; }
        #file-list-display { font-size: 12px; color: #666; margin-left: 5px; }

        /* èŠå¤©åŒºåŸŸ */
        #chat-container { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: var(--input-area-height); display: flex; flex-direction: column; gap: 15px; max-width: 900px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        .message { display: flex; align-items: flex-start; max-width: 85%; line-height: 1.6; }
        .message.user { align-self: flex-end; flex-direction: row-reverse; }
        .message.bot { align-self: flex-start; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; margin: 0 10px; }
        .user .avatar { background-color: #0056b3; color: white; }
        .bot .avatar { background-color: #10a37f; color: white; }
        .content { padding: 10px 16px; border-radius: 12px; position: relative; word-wrap: break-word; overflow-wrap: break-word; }
        .user .content { background-color: var(--user-msg-bg); color: var(--user-msg-text); border-bottom-right-radius: 2px; }
        .bot .content { background-color: var(--bot-msg-bg); color: var(--bot-msg-text); border-bottom-left-radius: 2px; }
        .bot .content pre { background: #2d2d2d; color: #fff; padding: 10px; border-radius: 6px; overflow-x: auto; }

        /* åº•éƒ¨è¾“å…¥ */
        #input-area { position: fixed; bottom: 0; left: 0; right: 0; background: var(--chat-bg); padding: 15px; border-top: 1px solid #ddd; display: flex; justify-content: center; align-items: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .input-wrapper { width: 100%; max-width: 900px; display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; outline: none; }
        input[type="text"]:focus { border-color: var(--user-msg-bg); }
        button#send-btn { padding: 0 20px; background-color: var(--user-msg-bg); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

<div id="rag-settings">
    <div class="setting-group">
        <select id="provider-select" title="é€‰æ‹©æ¨¡å‹æœåŠ¡å•†">
            <option value="ollama" selected>ğŸ¦™ Ollama</option>
            <option value="ZhiPuAI">ğŸ¤– æ™ºè°±AI</option>
        </select>
    </div>

    <div style="width: 1px; height: 24px; background: #ddd;"></div>

    <div class="setting-group">
        <label class="toggle-switch">
            <input type="checkbox" id="rag-mode-switch" checked>
            <span class="slider"></span>
        </label>
        <span class="setting-label" id="mode-label" style="color: #007bff;">ğŸ§  çŸ¥è¯†åº“æ¨¡å¼</span>
    </div>

    <div style="width: 1px; height: 24px; background: #ddd;"></div>

    <div id="kb-control-area">
        <div class="setting-group">
            <select id="rag-tag-select">
                <option value="" disabled selected>åŠ è½½ä¸­...</option>
            </select>
            <input type="text" id="rag-tag-input" placeholder="æ–°çŸ¥è¯†åº“åç§°">

            <button id="toggle-new-tag-btn" class="icon-btn" title="æ–°å»ºçŸ¥è¯†åº“">â•</button>
            <button id="refresh-tag-btn" class="icon-btn" title="åˆ·æ–°åˆ—è¡¨">ğŸ”„</button>
        </div>

        <div style="margin-left: 10px; display: flex; gap: 5px;">
            <button id="mode-file-btn" class="icon-btn active-mode" title="æ–‡ä»¶ä¸Šä¼ æ¨¡å¼">ğŸ“‚</button>
            <button id="mode-git-btn" class="icon-btn" title="Git ä»“åº“å¯¼å…¥æ¨¡å¼">ğŸ”—</button>
        </div>

        <div id="drop-zone" title="å¯ä»¥å°†æ–‡ä»¶æ‹–æ‹½åˆ°è¿™é‡Œ">
            <label for="file-input" class="btn-upload-trigger">ğŸ“‚ é€‰æ‹©æ–‡ä»¶</label>
            <input type="file" id="file-input" multiple>
            <span id="file-list-display"></span>
            <button id="upload-btn" class="btn-do-upload">ä¸Šä¼ </button>
        </div>

        <div id="git-zone">
            <input type="text" id="git-url-input" placeholder="Git HTTPS åœ°å€" autocomplete="off">
            <button id="git-import-btn" class="btn-do-upload">å¯¼å…¥ä»“åº“</button>
        </div>
    </div>
</div>

<div id="chat-container">
    <div class="message bot">
        <div class="avatar">AI</div>
        <div class="content">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI åŠ©æ‰‹ã€‚<br>è¯·é€‰æ‹©å·¦ä¸Šè§’çš„æ¨¡å‹ï¼Œå¼€å¯å¼€å…³å¯ä½¿ç”¨ã€çŸ¥è¯†åº“æ¨¡å¼ã€‘ã€‚</div>
    </div>
</div>

<div id="input-area">
    <div class="input-wrapper">
        <input type="text" id="user-input" placeholder="è¯·è¾“å…¥é—®é¢˜..." autocomplete="off">
        <button id="send-btn">å‘é€</button>
    </div>
</div>

<script>
    // === é…ç½®: å®šä¹‰ä¸åŒæœåŠ¡å•†çš„åŸºç¡€åœ°å€å’Œé»˜è®¤æ¨¡å‹ ===
    const CONFIG = {
        ollama: {
            baseUrl: 'http://localhost:8090/api/v1/ollama',
            defaultModel: 'qwen2.5:7b'
        },
        ZhiPuAI: {
            baseUrl: 'http://localhost:8090/api/v1/zhipu',
            defaultModel: 'glm-4' // æ™ºè°±çš„é»˜è®¤æ¨¡å‹å
        },
        // ç”¨äº RAGController çš„ API
        ragBaseUrl: 'http://localhost:8090/api/v1/rag'
    };

    // === DOM ===
    const chatContainer = document.getElementById('chat-container');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const ragModeSwitch = document.getElementById('rag-mode-switch');
    const kbControlArea = document.getElementById('kb-control-area');
    const modeLabel = document.getElementById('mode-label');
    const ragTagSelect = document.getElementById('rag-tag-select');
    const ragTagInput = document.getElementById('rag-tag-input');
    const toggleNewTagBtn = document.getElementById('toggle-new-tag-btn');
    const refreshTagBtn = document.getElementById('refresh-tag-btn');
    const fileInput = document.getElementById('file-input');
    const uploadBtn = document.getElementById('upload-btn');
    const fileListDisplay = document.getElementById('file-list-display');
    const dropZone = document.getElementById('drop-zone');

    // æ–°å¢ DOM
    const providerSelect = document.getElementById('provider-select');
    const modeFileBtn = document.getElementById('mode-file-btn');
    const modeGitBtn = document.getElementById('mode-git-btn');
    const gitZone = document.getElementById('git-zone');
    const gitUrlInput = document.getElementById('git-url-input');
    const gitImportBtn = document.getElementById('git-import-btn');

    let isNewTagMode = false;

    // === 1. æ¨¡å¼åˆ‡æ¢é€»è¾‘ (Ragå¼€å…³) ===
    ragModeSwitch.addEventListener('change', () => {
        const isRagOn = ragModeSwitch.checked;
        if (isRagOn) {
            kbControlArea.classList.remove('disabled');
            modeLabel.textContent = "ğŸ§  çŸ¥è¯†åº“æ¨¡å¼";
            modeLabel.style.color = "#007bff";
            userInput.placeholder = "åŸºäºæ–‡æ¡£æé—®...";
        } else {
            kbControlArea.classList.add('disabled');
            modeLabel.textContent = "ğŸ’¬ è‡ªç”±èŠå¤©";
            modeLabel.style.color = "#555";
            userInput.placeholder = "éšä¾¿èŠèŠ...";
        }
    });

    // === 2. ä¸Šä¼ æ¨¡å¼åˆ‡æ¢ (File vs Git) ===
    modeFileBtn.addEventListener('click', () => switchUploadMode('file'));
    modeGitBtn.addEventListener('click', () => switchUploadMode('git'));

    function switchUploadMode(mode) {
        if (mode === 'file') {
            dropZone.style.display = 'flex';
            gitZone.style.display = 'none';
            modeFileBtn.classList.add('active-mode');
            modeGitBtn.classList.remove('active-mode');
        } else {
            dropZone.style.display = 'none';
            gitZone.style.display = 'flex';
            modeFileBtn.classList.remove('active-mode');
            modeGitBtn.classList.add('active-mode');
            gitUrlInput.focus();
        }
    }

    // === 3. çŸ¥è¯†åº“æ ‡ç­¾ç®¡ç† ===
    window.onload = loadRagTags;
    refreshTagBtn.addEventListener('click', loadRagTags);

    toggleNewTagBtn.addEventListener('click', () => {
        isNewTagMode = !isNewTagMode;
        if (isNewTagMode) {
            ragTagSelect.style.display = 'none';
            ragTagInput.style.display = 'block';
            toggleNewTagBtn.textContent = 'ğŸ”™';
            ragTagInput.focus();
        } else {
            ragTagSelect.style.display = 'block';
            ragTagInput.style.display = 'none';
            toggleNewTagBtn.textContent = 'â•';
        }
    });

    async function loadRagTags() {
        try {
            const response = await fetch(`${CONFIG.ragBaseUrl}/list`);
            const result = await response.json();
            ragTagSelect.innerHTML = '';
            if (result.code === "0000" && result.data && result.data.length > 0) {
                result.data.forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag;
                    option.textContent = tag;
                    ragTagSelect.appendChild(option);
                });
                ragTagSelect.value = result.data[0];
            } else {
                ragTagSelect.innerHTML = '<option disabled selected>æš‚æ— </option>';
            }
        } catch (e) {
            console.error(e);
            ragTagSelect.innerHTML = '<option disabled>åŠ è½½å¤±è´¥</option>';
        }
    }

    function getCurrentRagTag() {
        return isNewTagMode ? ragTagInput.value.trim() : ragTagSelect.value;
    }

    // === 4. æ–‡ä»¶ä¸Šä¼ ä¸æ‹–æ‹½é€»è¾‘ ===
    fileInput.addEventListener('change', updateFileListDisplay);

    function updateFileListDisplay() {
        if (fileInput.files.length > 0) fileListDisplay.textContent = `(${fileInput.files.length}ä¸ªæ–‡ä»¶)`;
        else fileListDisplay.textContent = '';
    }

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
    });

    dropZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files.length > 0) {
            fileInput.files = files;
            updateFileListDisplay();
        }
    }

    uploadBtn.addEventListener('click', async () => {
        const ragTag = getCurrentRagTag();
        if (!ragTag || ragTag === "æš‚æ— ") return alert("è¯·é€‰æ‹©æˆ–æ–°å»ºä¸€ä¸ªçŸ¥è¯†åº“åç§°");
        if (fileInput.files.length === 0) return alert("è¯·é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶");

        const provider = providerSelect.value;
        const formData = new FormData();
        formData.append('ragTag', ragTag);
        formData.append('model', provider);
        for (let i = 0; i < fileInput.files.length; i++) formData.append('files', fileInput.files[i]);

        uploadBtn.disabled = true;
        uploadBtn.textContent = '...';

        try {
            const response = await fetch(`${CONFIG.ragBaseUrl}/upload`, { method: 'POST', body: formData });
            const result = await response.json();
            if (result.code === "0000") {
                alert("ä¸Šä¼ æˆåŠŸ");
                fileInput.value = '';
                updateFileListDisplay();
                if (isNewTagMode) {
                    await loadRagTags();
                    ragTagSelect.value = ragTag;
                    toggleNewTagBtn.click();
                }
            } else alert(result.info);
        } catch (e) { alert("ä¸Šä¼ å¤±è´¥"); }
        finally { uploadBtn.disabled = false; uploadBtn.textContent = 'ä¸Šä¼ '; }
    });

    // === 5. Git å¯¼å…¥é€»è¾‘ ===
    gitImportBtn.addEventListener('click', async () => {
        const ragTag = getCurrentRagTag();
        if (!ragTag || ragTag === "æš‚æ— ") return alert("è¯·é€‰æ‹©æˆ–æ–°å»ºä¸€ä¸ªçŸ¥è¯†åº“åç§°");

        const gitUrl = gitUrlInput.value.trim();
        if (!gitUrl) return alert("è¯·è¾“å…¥ Git ä»“åº“åœ°å€");
        if (!gitUrl.startsWith("http")) return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ HTTP/HTTPS Git åœ°å€");

        const provider = providerSelect.value;

        gitImportBtn.disabled = true;
        gitImportBtn.textContent = 'å…‹éš†è§£æä¸­...';

        try {
            const targetUrl = `${CONFIG.ragBaseUrl}/git?tag=${encodeURIComponent(ragTag)}&url=${encodeURIComponent(gitUrl)}&model=${encodeURIComponent(provider)}`;

            const response = await fetch(targetUrl, { method: 'GET' });
            const result = await response.json();

            if (result.code === "0000") {
                alert(`Git ä»“åº“å¯¼å…¥æˆåŠŸï¼\nçŸ¥è¯†åº“: ${ragTag}\næ¨¡å‹: ${provider}`);
                gitUrlInput.value = '';
                if (isNewTagMode) {
                    await loadRagTags();
                    ragTagSelect.value = ragTag;
                    toggleNewTagBtn.click();
                }
            } else {
                alert("å¯¼å…¥å¤±è´¥: " + (result.info || "æœªçŸ¥é”™è¯¯"));
            }
        } catch (e) {
            console.error(e);
            alert("è¯·æ±‚å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åç«¯æœåŠ¡");
        } finally {
            gitImportBtn.disabled = false;
            gitImportBtn.textContent = 'å¯¼å…¥ä»“åº“';
        }
    });

    // === 6. æ ¸å¿ƒå¯¹è¯é€»è¾‘ (å«ç¬¦å·è¿‡æ»¤) ===
    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        const isRagOn = ragModeSwitch.checked;
        const provider = providerSelect.value;
        const currentConfig = CONFIG[provider];

        let requestUrl = '';

        if (isRagOn) {
            const ragTag = getCurrentRagTag();
            if (!ragTag || ragTag === "æš‚æ— ") return alert("è¯·å…ˆé€‰æ‹©çŸ¥è¯†åº“ï¼Œæˆ–è€…å…³é—­å¼€å…³è¿›è¡Œçº¯èŠ");

            requestUrl = `${currentConfig.baseUrl}/generate_stream_rag?model=${encodeURIComponent(currentConfig.defaultModel)}&ragTag=${encodeURIComponent(ragTag)}&message=${encodeURIComponent(text)}`;
        } else {
            requestUrl = `${currentConfig.baseUrl}/generate_stream?model=${encodeURIComponent(currentConfig.defaultModel)}&message=${encodeURIComponent(text)}`;
        }

        appendMessage('user', text);
        userInput.value = '';
        setLoading(true);

        const botMsgDiv = appendMessage('bot', '<span class="cursor">...</span>');
        let fullText = '';

        try {
            const response = await fetch(requestUrl, {
                method: 'GET',
                headers: { 'Accept': 'text/event-stream' }
            });

            if (!response.ok) throw new Error('è¿æ¥å¤±è´¥');

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n\n');
                buffer = lines.pop();

                for (const line of lines) {
                    if (line.trim().startsWith('data:')) {
                        try {
                            const data = JSON.parse(line.replace('data:', '').trim());
                            let content = data?.result?.output?.content || "";

                            // ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šè¿‡æ»¤æ‰æ™ºè°± AI çš„ Grounding æ ‡è®° ğŸ”¥ğŸ”¥ğŸ”¥
                            content = content.replace(/<\|begin_of_box\|>/g, '').replace(/<\|end_of_box\|>/g, '');

                            fullText += content;
                        } catch (e) {}
                    }
                }
                botMsgDiv.innerHTML = marked.parse(fullText);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        } catch (error) {
            botMsgDiv.innerHTML += `<br><span style="color:red">[é”™è¯¯: ${error.message}]</span>`;
        } finally {
            setLoading(false);
        }
    }

    function appendMessage(role, text) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${role}`;
        msgDiv.innerHTML = `<div class="avatar">${role === 'user' ? 'æˆ‘' : 'AI'}</div><div class="content">${text}</div>`;
        chatContainer.appendChild(msgDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        return msgDiv.querySelector('.content');
    }

    function setLoading(isLoading) {
        sendBtn.disabled = isLoading;
        userInput.disabled = isLoading;
        if(!isLoading) userInput.focus();
    }
</script>
</body>
</html>